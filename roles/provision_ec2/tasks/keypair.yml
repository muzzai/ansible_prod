---
# Manage EC2 key pair for SSH access and publish facts for later tasks

- name: Expand local SSH key paths
  ansible.builtin.set_fact:
    provision_ec2_provision_private_key_path_expanded: "{{ provision_ec2_provision_private_key_path | regex_replace('^~', lookup('env', 'HOME')) }}"
    provision_ec2_provision_public_key_path_expanded: "{{ provision_ec2_provision_public_key_path | regex_replace('^~', lookup('env', 'HOME')) }}"

- name: Ensure SSH key directory exists
  ansible.builtin.file:
    path: "{{ provision_ec2_provision_private_key_path_expanded | dirname }}"
    state: directory
    mode: '0700'
  delegate_to: "{{ provision_control_host }}"
  run_once: true

- name: Generate EC2 key pair
  ansible.builtin.shell: |
    umask 0177
    ssh-keygen -t {{ provision_ec2_ssh_key_type }} \
      -b {{ provision_ec2_ssh_key_bits }} \
      -m PEM \
      -f "{{ provision_ec2_provision_private_key_path_expanded }}" \
      -N "" \
      -C "ansible-generated-{{ provision_ec2_key_name }}"
  delegate_to: "{{ provision_control_host }}"
  changed_when: false
  run_once: true

- name: Read public key content
  ansible.builtin.slurp:
    src: "{{ provision_ec2_provision_public_key_path_expanded }}"
  register: provision_ec2_public_key_content
  delegate_to: "{{ provision_control_host }}"
  run_once: true

- name: Read private key content for Vault storage
  ansible.builtin.slurp:
    src: "{{ provision_ec2_provision_private_key_path_expanded }}"
  register: provision_ec2_private_key_content
  delegate_to: "{{ provision_control_host }}"
  run_once: true

- name: Assemble key pair facts
  ansible.builtin.set_fact:
    provision_ec2_keypair_info:
      key_name: "{{ provision_ec2_key_name }}"
      key_fingerprint: "{{ provision_ec2_ec2_keypair_result.key.fingerprint | default('') }}"
      public_key: "{{ provision_ec2_public_key_content.content | b64decode if provision_ec2_public_key_content is defined else '' }}"
      private_key: "{{ provision_ec2_private_key_content.content | b64decode if provision_ec2_private_key_content is defined else '' }}"
      key_type: "{{ provision_ec2_ssh_key_type }}"
      key_bits: "{{ provision_ec2_ssh_key_bits }}"
  delegate_to: "{{ provision_control_host }}"
  run_once: true

- name: Import key pair into AWS
  amazon.aws.ec2_key:
    name: "{{ provision_ec2_key_name }}"
    key_material: "{{ provision_ec2_keypair_info.public_key }}"
    state: present
    region: "{{ provision_ec2_aws_region }}"
    tags:
      Name: "{{ provision_ec2_key_name }}"
      Environment: "{{ provision_ec2_environment }}"
      Project: "{{ provision_ec2_project }}"
      ManagedBy: ansible
      CreatedBy: "{{ ansible_user | default('ansible') }}"
      CreatedAt: "{{ ansible_date_time.iso8601 }}"
  register: provision_ec2_ec2_keypair_result
  delegate_to: "{{ provision_control_host }}"
  run_once: true

- name: Show key pair status
  ansible.builtin.debug:
    msg:
      - "EC2 key pair: {{ provision_ec2_key_name }}"
      - "Fingerprint: {{ provision_ec2_keypair_info.key_fingerprint | default('N/A') }}"
      - "Public key length: {{ provision_ec2_keypair_info.public_key | length }}"
      - "Key ready for instance launch"
